{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}ZTracer{% endblock %}

{% block content %}
    <div class="container">
      <div id="loadavg" style="min-width:400px;height:300px"></div>
      <div id="stat" style="min-width:400px;height:300px"></div>
      <div id="intr" style="min-width:400px;height:300px"></div>
      <div id="softirq" style="min-width:400px;height:300px"></div>
      <div id="ctxt" style="min-width:400px;height:300px"></div>
      <div id="fork" style="min-width:400px;height:300px"></div>
      <div id="runnblocked" style="min-width:400px;height:300px"></div>
      <div id="mem" style="min-width:400px;height:300px"></div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    function autoupdate(){
        $.post("/update/all",
            {
                data : 'index',
                id  : null,
            },
            function(data,status){
                if(status == "success")
                {
                    if(data.loadavg)
                    {
                        var series = chart.series;
                        activeLastPointToolip(chart);
                        var x = data.loadavg[0], //时间点
                        y = data.loadavg[1][0];
                        series[0].addPoint([x, y], false, true); //由于要画多个点，第二个参数（自动刷新）不要使能，最后统一重绘
                        y = data.loadavg[1][1];
                        series[1].addPoint([x, y], false, true);
                        y = data.loadavg[1][2];
                        series[2].addPoint([x, y], false, true);
                        chart.redraw();
                        activeLastPointToolip(chart);
                    }
                    if(data.stat)
                    {
                        var series = chart_stat.series;
                        activeLastPointToolip(chart_stat);
                        var x = data.stat[0], 
                        y = data.stat[1][0];
                        series[0].addPoint([x, y], false, true);
                        y = data.stat[1][1];
                        series[1].addPoint([x, y], false, true);
                        y = data.stat[1][2];
                        series[2].addPoint([x, y], false, true);
                        y = data.stat[1][4];
                        series[3].addPoint([x, y], false, true);
                        y = data.stat[1][5];
                        series[4].addPoint([x, y], false, true);
                        y = data.stat[1][6];
                        series[5].addPoint([x, y], false, true);
                        y = data.stat[1][7];
                        series[6].addPoint([x, y], false, true);
                        chart_stat.redraw();
                        activeLastPointToolip(chart_stat);
                    }
                    if(data.intr)
                    {
                        var series = chart_intr.series;
                        activeLastPointToolip(chart_intr);
                        var x = data.intr[0], 
                        dict = data.intr[1];
                        for (var i in dict) { 
                            y = dict[i];
                            index = parseInt(i);
                            if(index == 0)
                                series[index].addPoint([x, y], false, true);
                        } 
                        chart_intr.redraw();
                        activeLastPointToolip(chart_intr);
                    }

                    if(data.softirq)
                    {
                        var series = chart_softirq.series;
                        activeLastPointToolip(chart_softirq);
                        var x = data.softirq[0], 
                        y = data.softirq[1][1];
                        series[0].addPoint([x, y], false, true);
                        y = data.softirq[1][2];
                        series[1].addPoint([x, y], false, true);
                        y = data.softirq[1][3];
                        series[2].addPoint([x, y], false, true);
                        y = data.softirq[1][4];
                        series[3].addPoint([x, y], false, true);
                        y = data.softirq[1][5];
                        series[4].addPoint([x, y], false, true);
                        y = data.softirq[1][6];
                        series[5].addPoint([x, y], false, true);
                        y = data.softirq[1][7];
                        series[6].addPoint([x, y], false, true);
                        y = data.softirq[1][8];
                        series[7].addPoint([x, y], false, true);
                        y = data.softirq[1][9];
                        series[8].addPoint([x, y], false, true);
                        y = data.softirq[1][10];
                        series[9].addPoint([x, y], false, true);
                        chart_softirq.redraw();
                        activeLastPointToolip(chart_softirq);
                    }

                    if(data.ctxt)
                    {
                        var series = chart_run_block.series;
                        activeLastPointToolip(chart_run_block);
                        var x = data.ctxt[0], 
                        y = data.ctxt[1][2];
                        series[0].addPoint([x, y], false, true); 
                        y = data.ctxt[1][3];
                        series[1].addPoint([x, y], false, true);
                        chart_run_block.redraw();
                        activeLastPointToolip(chart_run_block);

                        var series = chart_ctxt.series;
                        activeLastPointToolip(chart_ctxt);
                        var x = data.ctxt[0], 
                        y = data.ctxt[1][0];
                        series[0].addPoint([x, y], false, true); 
                        chart_ctxt.redraw();
                        activeLastPointToolip(chart_ctxt);
                        
                        var series = chart_fork.series;
                        activeLastPointToolip(chart_fork);
                        var x = data.ctxt[0], 
                        y = data.ctxt[1][1];
                        series[0].addPoint([x, y], false, true); 
                        chart_fork.redraw();
                        activeLastPointToolip(chart_fork);

                    }
                }
        });
    }

    Highcharts.setOptions({
            global: {
                    useUTC: false
            }
    });
    function activeLastPointToolip(chart) {
            var points = chart.series[0].points;
            chart.tooltip.refresh(points[points.length -1]);
    }
    
    var chart = new Highcharts.Chart({
            chart: {
                    type: 'spline',
                    renderTo: 'loadavg',
                    marginRight: 10,
                    events: {
                            load: function () {
                                setInterval(autoupdate,1000); 
                            }
                    }
            },
            title: {
                    text: 'loadavg'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '负载'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: '1分钟',
                    data: {{ loadavg.getline('load1') }}
            },
            {
                    name: '5分钟',
                    data:  {{ loadavg.getline('load5') }}
            },
            {
                    name: '15分钟',
                    data:  {{ loadavg.getline('load15') }}
            }]
    });
    
    var chart_stat = new Highcharts.Chart({
            chart: {
                    type: 'area',
                    renderTo: 'stat',
                    marginRight: 10,
            },
            title: {
                    text: 'CPU利用率'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '占用率'
                    },
                    min: 0,
                    max:100,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            plotOptions: {
                area: {
                    grouping: false,
                    shadow: false,
                    borderWidth: 0,
                    stacking: 'normal'
                }
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'user',
                    data: {{ stat.getline('user') }}
            },
            {
                    name: 'nice',
                    data: {{ stat.getline('nice') }}
            },
            {
                    name: 'system',
                    data: {{ stat.getline('system') }}
            },
            {
                    name: 'iowait',
                    data: {{ stat.getline('iowait') }}
            },
            {
                    name: 'irq',
                    data: {{ stat.getline('irq') }}
            },
            {
                    name: 'softirq',
                    data: {{ stat.getline('softirq') }}
            },
            {
                    name: 'steal',
                    data: {{ stat.getline('steal') }}
            }]
    });

    var chart_intr = new Highcharts.Chart({
            chart: {
                    type: 'area',
                    renderTo: 'intr',
                    marginRight: 10,
            },
            title: {
                    text: 'hw irq'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '次数'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            plotOptions: {
                area: {
                    grouping: false,
                    shadow: false,
                    borderWidth: 0,
                    stacking: 'normal'
                }
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'irq',
                    data: {{ stat.getline('h_all') }}
            }]
    });

    
    var chart_softirq = new Highcharts.Chart({
            chart: {
                    type: 'area',
                    renderTo: 'softirq',
                    marginRight: 10,
            },
            title: {
                    text: 'softirq'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '次数'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            plotOptions: {
                area: {
                    grouping: false,
                    shadow: false,
                    borderWidth: 0,
                    stacking: 'normal'
                }
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'hi',
                    data: {{ stat.getline('s_hi') }}
            },
            {
                    name: 'timer',
                    data: {{ stat.getline('s_timer') }}
            },
            {
                    name: 'net_tx',
                    data: {{ stat.getline('s_net_tx') }}
            },
            {
                    name: 'net_rx',
                    data: {{ stat.getline('s_net_rx') }}
            },
            {
                    name: 'block',
                    data: {{ stat.getline('s_block') }}
            },
            {
                    name: 'block_iopoll',
                    data: {{ stat.getline('s_block_iopoll') }}
            },
            {
                    name: 'tasklet',
                    data: {{ stat.getline('s_tasklet') }}
            },
            {
                    name: 'sched',
                    data: {{ stat.getline('s_sched') }}
            },
            {
                    name: 'hrtimer',
                    data: {{ stat.getline('s_hrtimer') }}
            },
            {
                    name: 'rcu',
                    data: {{ stat.getline('s_rcu') }}
            }]
    });
    
    var chart_ctxt = new Highcharts.Chart({
            chart: {
                    type: 'spline',
                    renderTo: 'ctxt',
                    marginRight: 10,
            },
            title: {
                    text: 'ctxt'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '切换次数'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'ctxt',
                    data: {{ loadavg.getline('ctxt') }}
            }]
    });

    var chart_fork = new Highcharts.Chart({
            chart: {
                    type: 'spline',
                    renderTo: 'fork',
                    marginRight: 10,
            },
            title: {
                    text: 'fork'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '进程数量'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'fork',
                    data: {{ loadavg.getline('fork') }}
            }]
    });
    
    var chart_run_block = new Highcharts.Chart({
            chart: {
                    type: 'spline',
                    renderTo: 'runnblocked',
                    marginRight: 10,
            },
            title: {
                    text: 'run/blocked'
            },
            subtitle: {
                    text: null
            },
            xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
            },
            yAxis: {
                    title: {
                            text: '进程数量'
                    },
                    min: 0,
            },
            tooltip: {
                    formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                    Highcharts.numberFormat(this.y, 2);
                    }
            },
            legend: {
                    layout: 'vertical',
                    floating: true,
                    align: 'left',
                    verticalAlign: 'top',
                    x: 90,
                    y: 45,
            },
            credits: {  
              enabled:false  
            },  
            series: [{
                    name: 'run',
                    data: {{ loadavg.getline('run') }}
            },
            {
                    name: 'blocked',
                    data:  {{ loadavg.getline('blocked') }}
            }]
    });
</script>
{% endblock %}
