{% extends "cpu_base.html" %}
{% block title %}ZTracer{% endblock %}

{% block main_content %}
    <div class="container">
        <div class="row">
            <hr/>
            <div class="col-md-4">
            {{ wtf.quick_form(form) }}
            <label id="perfstart" class="btn btn-success">开始采样</label>
            </div>
            <div class="col-md-12">
                <hr/>
                <div class="progress">
                    <div id="progress1" class="progress-bar" role="progressbar" aria-valuenow="60" 
                        aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="perfok" align="center"></div>
{% endblock %}


{% block scripts %}
<script type="text/javascript">

    var percent = 0;
    var time = 0;
    var cnt = 0;
    var timer = 1; 
    var done = 0;

    $("#perfstart").click(function(){
        $('.progress-bar').attr('aria-valuenow', 0).css('width', 0 + '%').text(0 + '%');
        percent = 0;
        cnt = 0; 
        timer = setInterval(clickdone,100);
        time = $("#time").val();
        $.post("/perf/start",
        {
            cpu : $("#cpu").val(),
            pid  : $("#pid").val(),
            time : $("#time").val(),
            hz : $("#hz").val(),
            adv : $("#adv").val(),
        },
        function(data,status){
            if(status == "success")
            {
                $('.progress-bar').attr('aria-valuenow', 100).css('width', 100 + '%').text(100 + '%');
                var div = document.getElementById("perfok");
                var linkTmp = document.createElement("a");
                if(data.result == 'ok')
                {
                    linkTmp.href = "/#/heatmap/perf.stack";
                    linkTmp.innerText = "查看结果"; 
                    done = 1;
                }
                else
                {
                    linkTmp.innerText = "运行perf失败，确保安装了perf工具"; 
                }
                div.appendChild(linkTmp);
            }
        });
    });

    function clickdone(){
        cnt += 1;
        percent = Math.round(cnt * 10 / time);
        if(percent >= 100 || done == 1)
        {
            $('.progress-bar').attr('aria-valuenow', 100).css('width', 100 + '%').text(100 + '%');
            clearInterval(timer);
            window.location.href="/#/heatmap/perf.stack";
        }
        else
        {
            $('.progress-bar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
        }
    }
</script>
{% endblock %}
